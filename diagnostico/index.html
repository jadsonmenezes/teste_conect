<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Diagn√≥stico de Conex√£o - Goomer</title>

<style>
    body {
        background: #0f1116;
        color: #ffffff;
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 20px;
    }

    h1 {
        font-size: 22px;
        margin-bottom: 15px;
    }

    label {
        font-size: 15px;
        font-weight: bold;
    }

    input, textarea {
        width: 100%;
        padding: 12px;
        margin-top: 6px;
        margin-bottom: 14px;
        border-radius: 8px;
        border: 1px solid #3a3f47;
        background: #1c1f26;
        color: #fff;
        font-size: 15px;
    }

    button {
        width: 100%;
        padding: 14px;
        margin-top: 8px;
        margin-bottom: 16px;
        background: #00c851;
        border: none;
        border-radius: 12px;
        color: #000;
        font-size: 17px;
        font-weight: bold;
        cursor: pointer;
    }

    button:disabled {
        background: #444;
        color: #999;
        cursor: not-allowed;
    }

    .card {
        background: #16191f;
        padding: 16px;
        border-radius: 12px;
        margin-bottom: 18px;
        border: 1px solid #2a2f36;
    }

    .status-ok {
        color: #00ff99;
        font-weight: bold;
    }

    .status-error {
        color: #ff6161;
        font-weight: bold;
    }

    pre {
        white-space: pre-wrap;
        background: #111318;
        padding: 14px;
        border-radius: 10px;
        border: 1px solid #333;
        font-size: 13px;
    }
</style>
</head>

<body>

<h1>üîç Diagn√≥stico de Conex√£o (HTTPS / TLS / WS)</h1>

<label>URL do delivery que est√° com erro</label>
<input id="inputUrl" placeholder="https://exemplo.goomer.app/" />

<label>Observa√ß√µes (opcional)</label>
<textarea id="inputNotes" placeholder="Ex.: erro ERR_SSL_PROTOCOL_ERROR no celular do cliente."></textarea>

<label style="display:flex;align-items:center;gap:6px;margin-top:6px;">
    <input type="checkbox" id="checkWS" checked />
    Incluir teste de WebSocket seguro (wss://)
</label>

<button onclick="runTests()">‚ñ∂ Executar testes de conex√£o</button>
<button id="copyBtn" onclick="copyResult()" style="background:#39c0ed;">üìã Copiar resultado</button>

<div id="results"></div>

<h2>Resumo t√©cnico (para enviar ao suporte)</h2>
<pre id="output"></pre>

<script>
async function runTests() {
    const url = document.getElementById("inputUrl").value.trim();
    const notes = document.getElementById("inputNotes").value.trim();
    const includeWS = document.getElementById("checkWS").checked;

    if (!url.startsWith("https://")) {
        alert("Insira uma URL HTTPS v√°lida.");
        return;
    }

    const host = url.replace("https://", "").replace("/", "");

    document.getElementById("results").innerHTML = "<div class='card'>Executando testes...</div>";

    let result = {
        inputUrl: url,
        testedHost: host,
        notes: notes || null,
        environment: {
            timestamp: new Date().toISOString(),
            userAgent: navigator.userAgent,
            language: navigator.language,
            platform: navigator.platform,
            connection: navigator.connection
                ? {
                    effectiveType: navigator.connection.effectiveType,
                    rtt: navigator.connection.rtt,
                    downlink: navigator.connection.downlink,
                    saveData: navigator.connection.saveData
                }
                : "unsupported"
        },
        results: []
    };

    // ============================
    // TESTE 1 ‚Äî HTTPS b√°sico
    // ============================
    let httpsOK = false;
    try {
        await fetch(url, { mode: "no-cors" });
        httpsOK = true;
        result.results.push({ id: "https_direct", ok: true });
    } catch (e) {
        result.results.push({ id: "https_direct", ok: false, error: e.toString() });
    }

    // ============================
    // TESTE 2 ‚Äî HEAD (status HTTP)
    // ============================
    try {
        const r = await fetch(url, { method: "HEAD" });
        result.results.push({ id: "head_status", ok: true, status: r.status });
    } catch (e) {
        result.results.push({ id: "head_status", ok: false, error: e.toString() });
    }

    // ============================
    // TESTE 3 ‚Äî GET CORS
    // ============================
    try {
        await fetch(url, { method: "GET" });
        result.results.push({ id: "get_cors", ok: true });
    } catch (e) {
        result.results.push({ id: "get_cors", ok: false, error: e.toString() });
    }

    // ============================
    // TESTE 4 ‚Äî IMAGEM (TLS)
    // ============================
    try {
        const img = await new Promise((resolve, reject) => {
            const i = new Image();
            i.onload = resolve;
            i.onerror = reject;
            i.src = url + "/favicon.ico";
        });
        result.results.push({ id: "img_tls", ok: true });
    } catch (e) {
        result.results.push({ id: "img_tls", ok: false });
    }

    // ============================
    // TESTE 5 ‚Äî WEBSOCKET
    // ============================
    if (includeWS) {
        try {
            let ws = new WebSocket("wss://" + host);
            await new Promise((resolve, reject) => {
                ws.onerror = reject;
                ws.onopen = resolve;
            });
            result.results.push({ id: "wss_test", ok: true });
        } catch (e) {
            result.results.push({ id: "wss_test", ok: false, error: e.toString() });
        }
    }

    // ============================
    // EXIBIR NA TELA
    // ============================
    let html = "";

    for (let r of result.results) {
        const ok = r.ok;
        html += `
        <div class="card">
            <b>${r.id}:</b> 
            <span class="${ok ? "status-ok" : "status-error"}">
                ${ok ? "OK" : "Falhou"}
            </span>
            ${r.error ? `<br><small>${r.error}</small>` : ""}
        </div>`;
    }

    document.getElementById("results").innerHTML = html;
    document.getElementById("output").textContent = JSON.stringify(result, null, 2);
}

function copyResult() {
    const text = document.getElementById("output").textContent;
    navigator.clipboard.writeText(text);
    alert("Resultado copiado!");
}
</script>

</body>
</html>
